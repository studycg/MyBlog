蒙特卡洛积分

给任何一个函数想计算定积分 不是能很好的解析出原函数

黎曼积分：分解为无数微小的长方形，算它们的面积之和 

![image-20260124153047156](./assets/image-20260124153047156.png)

蒙特卡洛积分：随机的在[a,b]取很多xi，求函数值。用此时的函数值当高度求整个矩形(底为b-a)面积，求很多次后平均。

![image-20260124153424607](./assets/image-20260124153424607.png)

![image-20260124154001455](./assets/image-20260124154001455.png)

![image-20260124154032700](./assets/image-20260124154032700.png)

![image-20260124154039842](./assets/image-20260124154039842.png)

面积=宽度×平均高度  合理 这个例子是在b-a内均匀采样

![image-20260124154332903](./assets/image-20260124154332903.png)

# 路径追踪

Whitted风格Ray Tracing的问题：

1. 无法处理Glossy refection
2. 无法处理Diffuse materials

渲染方程是对的，但是：

1. 渲染方程要解积分
2. 渲染方程是递归的

## 直接光照

假设和Phong模型一样方向朝外，并且只考虑直接光照

![image-20260124235810822](./assets/image-20260124235810822.png)

![image-20260125000513055](./assets/image-20260125000513055.png)

因为半球面积是2Π，每一个单位立体角的概率为1/2Π。

![image-20260125000601263](./assets/image-20260125000601263.png)

![image-20260125000609569](./assets/image-20260125000609569.png)

## 全局光照

![image-20260125000822011](./assets/image-20260125000822011.png)

既然反射面也是Radiance，为什么要和光源区别对待呢？（所以一样的）

从Q到P反射了多少Radiance？就好像在P点观察Q点一样

Q点反射到P点的Radiance相当于在Q点算出的直接光照 

![image-20260125001124468](./assets/image-20260125001124468.png)

这就是个递归的过程

### 问题1：光线的数量会爆炸 会指数爆炸

![image-20260125001524299](./assets/image-20260125001524299.png)

只有当N=1时 不会指数爆炸（噪声非常大）

![image-20260125001748103](./assets/image-20260125001748103.png)

N=1时不再是反射一束光而是反射一条光线 形成了一条连接试点和光源的路径 所以叫Path

![image-20260125002144211](./assets/image-20260125002144211.png)

![image-20260125002721852](./assets/image-20260125002721852.png)

### 问题2：递归没出口

![image-20260125002830062](./assets/image-20260125002830062.png)

限制递归次数（弹射次数）会有能量损耗，真实世界就是无限次弹射的。

### 俄罗斯轮盘赌

定义一个概率P，以一定的概率P往某一方向打一条光线，着色结果除以P。

以1-P的概率不发出光线。

二者最后的期望不变。

![image-20260125003319497](./assets/image-20260125003319497.png)

![image-20260125003437967](./assets/image-20260125003437967.png)

### 对光源积分

着色点均匀的往四面八方采样 这样会造成浪费

![image-20260125012242905](./assets/image-20260125012242905.png)

蒙特卡洛方法没规定只能用某一种（均匀）的PDF来采样

现在着色点不在四面八方采样而是在光源上的采样

![image-20260125012302063](./assets/image-20260125012302063.png)

但是蒙特卡洛方法规定在哪里采样在哪里积分，在光源上采样但是在立体角上积分，这不一致。

要把渲染方程写为在光源上微分的面积进行积分

那么dw与dA什么关系？

![image-20260125012716707](./assets/image-20260125012716707.png)

![image-20260125012756638](./assets/image-20260125012756638.png)

将光线传播拆为：

1. 光源对这一点的贡献
2. 其它所有非光源对这点的贡献

![image-20260125015839249](./assets/image-20260125015839249.png)

![image-20260125015846494](./assets/image-20260125015846494.png)

最后加上遮挡判断：

![image-20260125020024125](./assets/image-20260125020024125.png)

