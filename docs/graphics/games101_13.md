# 加速结构

## Grid

1. 找出场景的包围盒
2. 将盒子分成一堆格子
3. 判定哪些格子里有物品

![image-20260122222437057](./assets/image-20260122222437057.png)

![image-20260122222446223](./assets/image-20260122222446223.png)

假设光线和格子求交非常快，和实际物体求交非常慢。

![image-20260122222539067](./assets/image-20260122222539067.png)

有可能格子内有物体，也与光线有交点，但物体与光线无交点。

不可能将每个格子都与光线做求交判断，实际上若与一个格子有交，那按图中例子来说，下一个有交的格子要么在它的上方，要么在它的右上方，要么在他的右边。

这对应了光栅化中如何显示一条线。

三维空间中有对应的算法找下一个格子。

加速效果怎么样？

格子太稀疏，没加速作用。格子太密计算量反而增加。

![image-20260122223011845](./assets/image-20260122223011845.png)

![image-20260122223016903](./assets/image-20260122223016903.png)

当空间中物体分布均匀时，效果好。

遇到Teapot in stadium效果不好。

## 空间划分Spatial Partitons

空旷的地方不需要太多格子

![image-20260122223341466](./assets/image-20260122223341466.png)

空间中切成八份：八叉树 划分什么时候停下来有不同的标准

KD树：在二维中先水平划分，再竖直划分，再水平划分...再三维中，每次沿着x划分，下一次y，下一次z。每次划分一次，像二叉树一样（保持了二叉树的性质）。

BSP：不是横平竖直的划分。但也是二分的思想。

![image-20260122224008419](./assets/image-20260122224008419.png)

![image-20260122224017800](./assets/image-20260122224017800.png)

![image-20260122224023633](./assets/image-20260122224023633.png)

实际上两边都需要划分，只是图中为了说明过程每次只划分一个格子。

KD树：

- 只当当前沿着哪一轴的方向划分
- 划分的位置（不一定在中间）
- 子节点（两个）
- 实际的物体只存在叶子节点上

假设树就长这样

![image-20260122230947214](./assets/image-20260122230947214.png)

![image-20260122230953660](./assets/image-20260122230953660.png)

![image-20260122231017498](./assets/image-20260122231017498.png)

![image-20260122231039864](./assets/image-20260122231039864.png)

![image-20260122231110083](./assets/image-20260122231110083.png)

![image-20260122231116149](./assets/image-20260122231116149.png)

如果光线和某个盒子无交点，什么都不用做。

如果有交点，则继续划分，只到分到无交点，或在叶子节点中有交点。

对于KDTree会有问题：得知道和哪些三角形有交集（三角形和哪些框有交集）

![image-20260122231620471](./assets/image-20260122231620471.png)

对于KDTree一个物体可能出现在多个叶子节点里 这点大伙都认为不好

## Bounding Volume Hierarchy(BVH)

BVH划分的不是空间而是**物体**

![image-20260122231902778](./assets/image-20260122231902778.png)

![image-20260122231912923](./assets/image-20260122231912923.png)

![image-20260122231929446](./assets/image-20260122231929446.png)

![image-20260122231946050](./assets/image-20260122231946050.png)

一个物体只可能出现在一个格子里，省去了三角形和包围盒求交问题。

但是BVH的两部分有可能相交（但也没什么问题）

关于怎么分很有说法

![image-20260122232535258](./assets/image-20260122232535258.png)

同样的把物体放叶子节点里其它做加速结构的判断。

一些划分方式：

- 每次沿着最长的轴去划分
- 取中间那个物体 这样分成两部分后左右两边深度（数量）差不多，树更平衡
- 比如取所有三角形的重心，沿x轴排序，找到中间的那个nlog_2(n)
- 其实只找中位数，不需要排序。一个序列的数找中位数（第i大的数）（第n/2的树）是可以在log_2(n)时间内完成的，算法叫快速选择算法（受快速排序影响）
- 当节点包含了较少物体时不再继续划分

![image-20260122233302061](./assets/image-20260122233302061.png)

BVH的数据结构

![image-20260122233338432](./assets/image-20260122233338432.png)

![image-20260122233415113](./assets/image-20260122233415113.png)

递归算法 像极了二叉树的遍历

KD树vsBVH树

![image-20260122233511579](./assets/image-20260122233511579.png)

# 辐射度量学

光的强度

精准的描述光的物理，给光各种属性：

- Radiant flux, intensity, irradiance, radiance

![image-20260122234031814](./assets/image-20260122234031814.png)

## Flux

![image-20260122234318653](./assets/image-20260122234318653.png)

或者：一个平面单位时间内通过的感光平面光子的数量就叫Flux

- 如何定义光源辐射出的各种能量
- 在任何一个表面接收到多少能量
- 光在传播过程中的能量如何定义

![image-20260123001127040](./assets/image-20260123001127040.png)

## Radiant Intensity

![image-20260123001257718](./assets/image-20260123001257718.png)

什么是立体角？

弧度制在空间中的延申

![image-20260123001556019](./assets/image-20260123001556019.png)

立体角如何计算？

![image-20260123002039211](./assets/image-20260123002039211.png)

为什么这么定义？

保持 $\phi$ 不变，$\theta$ 变化：

- 球面半径是 r
- 这是在一个**大圆**上走

弧长就是：rdθ

保持 $\theta$ 不变，$\phi$变化：

- 绕的不是大圆
- 而是**纬线圆**

这个圆的半径不是 r，而是：rsinθ

将两条近似垂直的最小边相乘就是的A

![image-20260123002101967](./assets/image-20260123002101967.png)






当然在球上把立体角积分得到的就是面积4Π

总亮度是Flux，Intensity就是光源在任何一个方向上的亮度。Intensity=FLux/单位立体角 。
$$
I=\frac{d\phi}{d\omega}
$$
![image-20260123002807255](./assets/image-20260123002807255.png)